<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jetson YOLOv8 Camera</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; }
    h1 { color: #76b900; text-align: center; margin-bottom: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    #videoCanvas { width: 100%; max-width: 800px; display: block; margin: 20px auto; border-radius: 8px; background: #000; }
    .status { text-align: center; padding: 10px; border-radius: 6px; margin: 10px auto; max-width: 800px; font-weight: 600; }
    .connected { background: #238636; color: #fff; }
    .disconnected { background: #da3633; color: #fff; }
    .panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin: 10px auto; max-width: 800px; }
    .panel h3 { color: #76b900; margin-bottom: 12px; font-size: 16px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 14px; }
    .stat-item { background: #0d1117; padding: 8px; border-radius: 4px; }
    .stat-label { color: #8b949e; font-size: 12px; }
    .stat-value { color: #76b900; font-weight: 700; font-size: 16px; }
    .control { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #21262d; }
    .control:last-child { border-bottom: none; }
    .toggle { position: relative; width: 48px; height: 24px; background: #30363d; border-radius: 12px; cursor: pointer; transition: background 0.3s; }
    .toggle.active { background: #238636; }
    .toggle-slider { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: left 0.3s; }
    .toggle.active .toggle-slider { left: 26px; }
    .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; padding: 10px; background: #0d1117; border-radius: 4px; }
    .class-item { display: flex; align-items: center; gap: 8px; padding: 6px; background: #161b22; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
    .class-item:hover { background: #21262d; }
    .class-item input { cursor: pointer; }
    .class-item label { cursor: pointer; flex: 1; font-size: 13px; }
    .btn { padding: 8px 16px; background: #76b900; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.8; }
    .btn-secondary { background: #30363d; color: #c9d1d9; }
    .slider-container { display: flex; align-items: center; gap: 12px; }
    .slider { flex: 1; height: 4px; border-radius: 2px; background: #30363d; outline: none; }
    .slider-value { min-width: 45px; text-align: center; color: #76b900; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Jetson YOLOv8 Camera</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <canvas id="videoCanvas"></canvas>
    
    <div class="panel">
      <h3>üìä Statistics</h3>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-label">FPS</div>
          <div class="stat-value" id="fps">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Memory</div>
          <div class="stat-value" id="memory">0 MB</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Backend</div>
          <div class="stat-value" id="backend">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Temp</div>
          <div class="stat-value" id="temperature">-</div>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <h3>üéØ Detection Controls</h3>
      <div class="control">
        <span>Enable Detection</span>
        <div class="toggle" id="detectionToggle" onclick="toggleDetection()">
          <div class="toggle-slider"></div>
        </div>
      </div>
      <div class="control">
        <span>Confidence Threshold</span>
        <div class="slider-container">
          <input type="range" class="slider" id="confSlider" min="0.1" max="0.9" value="0.4" step="0.05">
          <span class="slider-value" id="confValue">0.40</span>
        </div>
      </div>
    </div>
    
    <div class="panel">
      <h3>üè∑Ô∏è Select Detection Classes</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
        <button class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
        <button class="btn btn-secondary" onclick="selectCommon()">Common Objects</button>
      </div>
      <div class="class-grid" id="classGrid">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
  
  <script>
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    
    let ws = null;
    let detectionEnabled = true;
    let availableClasses = [];
    let selectedClasses = [];
    
    // Initialize
    (async () => {
      await loadClasses();
      await loadStatus();
      connectWebSocket();
      pollStats();
      setupEventListeners();
    })();
    
    async function loadClasses() {
      try {
        const res = await fetch('/api/detection/classes');
        const data = await res.json();
        availableClasses = data.classes;
        renderClassGrid();
      } catch (e) {
        console.error('Failed to load classes', e);
      }
    }
    
    function renderClassGrid() {
      const grid = document.getElementById('classGrid');
      grid.innerHTML = availableClasses.map(cls => `
        <div class="class-item" onclick="toggleClass(${cls.id})">
          <input type="checkbox" id="class_${cls.id}" ${selectedClasses.includes(cls.id) ? 'checked' : ''}>
          <label for="class_${cls.id}">${cls.name}</label>
        </div>
      `).join('');
    }
    
    function toggleClass(classId) {
      const checkbox = document.getElementById(`class_${classId}`);
      checkbox.checked = !checkbox.checked;
      updateSelectedClasses();
    }
    
    async function updateSelectedClasses() {
      selectedClasses = availableClasses
        .filter(cls => document.getElementById(`class_${cls.id}`).checked)
        .map(cls => cls.id);
      
      try {
        await fetch('/api/detection/classes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({class_indices: selectedClasses})
        });
      } catch (e) {
        console.error('Failed to update classes', e);
      }
    }
    
    function selectAll() {
      selectedClasses = availableClasses.map(cls => cls.id);
      renderClassGrid();
      updateSelectedClasses();
    }
    
    function deselectAll() {
      selectedClasses = [];
      renderClassGrid();
      updateSelectedClasses();
    }
    
    function selectCommon() {
      const common = ['person', 'car', 'truck', 'bicycle', 'motorcycle', 'dog', 'cat', 'bird'];
      selectedClasses = availableClasses
        .filter(cls => common.includes(cls.name))
        .map(cls => cls.id);
      renderClassGrid();
      updateSelectedClasses();
    }
    
    async function loadStatus() {
      try {
        const res = await fetch('/api/detection');
        const data = await res.json();
        detectionEnabled = data.enabled;
        selectedClasses = data.selected_classes || [];
        document.getElementById('detectionToggle').classList.toggle('active', detectionEnabled);
        document.getElementById('backend').textContent = data.backend || '-';
        renderClassGrid();
      } catch (e) {
        console.error('Failed to load status', e);
      }
    }
    
    async function toggleDetection() {
      detectionEnabled = !detectionEnabled;
      document.getElementById('detectionToggle').classList.toggle('active', detectionEnabled);
      
      try {
        await fetch('/api/detection', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({enabled: detectionEnabled})
        });
      } catch (e) {
        console.error('Failed to toggle detection', e);
      }
    }
    
    function setupEventListeners() {
      const confSlider = document.getElementById('confSlider');
      const confValue = document.getElementById('confValue');
      
      confSlider.addEventListener('input', (e) => {
        confValue.textContent = parseFloat(e.target.value).toFixed(2);
      });
      
      confSlider.addEventListener('change', async (e) => {
        try {
          await fetch('/api/detection/params', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({conf_threshold: parseFloat(e.target.value)})
          });
        } catch (err) {
          console.error('Failed to update confidence', err);
        }
      });
    }
    
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws/video`);
      ws.binaryType = 'arraybuffer';
      
      ws.onopen = () => {
        status.textContent = 'Connected';
        status.className = 'status connected';
      };
      
      ws.onclose = () => {
        status.textContent = 'Disconnected';
        status.className = 'status disconnected';
        setTimeout(connectWebSocket, 2000);
      };
      
      ws.onmessage = (event) => {
        const blob = new Blob([event.data], {type: 'image/jpeg'});
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(url);
        };
        img.src = url;
      };
    }
    
    async function pollStats() {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        document.getElementById('fps').textContent = data.actual_fps || 0;
        document.getElementById('memory').textContent = `${data.memory_mb || 0} MB`;
        document.getElementById('temperature').textContent = data.temperature || '-';
      } catch (e) {}
      setTimeout(pollStats, 1000);
    }
  </script>
</body>
</html>
