<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jetson Camera Stream</title>
  <style>
    body{background:#111;color:#eee;font-family:system-ui;margin:0;padding:20px}
    h1{color:#76b900;text-align:center}
    #videoCanvas{width:100%;max-width:800px;height:auto;display:block;margin:20px auto;background:#000;border-radius:8px}
    .status{max-width:800px;margin:0 auto;text-align:center;padding:8px;border-radius:6px}
    .connected{background:rgb(62, 113, 70);color:rgb(255, 255, 255)}
    .disconnected{background:#311;color:#f99}
    .stats-header{cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#333;border-radius:6px;margin-bottom:5px;}
    .stats-header:hover{background:#444}
    .stats-toggle{transition:transform 0.2s;}
    .stats-toggle.collapsed{transform:rotate(-90deg);}
    .stats-content{max-height:500px;overflow:hidden;transition:max-height 0.3s ease-out;}
    .stats-content.collapsed{max-height:0;}
  </style>
  </head>
<body>
  <h1>Jetson Camera Stream</h1>
  <div id="status" class="status disconnected">Disconnected</div>
  <div style="max-width:800px;margin:10px auto;">
    <div class="stats-header" onclick="toggleStats()">
      <span style="font-weight:bold;font-size:14px;">System Statistics</span>
      <span class="stats-toggle" id="statsToggle">▼</span>
    </div>
    <div class="stats-content" id="statsContent">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;font-size:13px;padding:10px;background:#222;border-radius:6px;">
        <div>FPS: <span id="fps" style="color:#76b900;font-weight:bold;">0</span></div>
        <div>Memory: <span id="memory" style="color:#76b900;font-weight:bold;">0 MB</span></div>
        <div>Quality: <span id="currentQuality" style="color:#76b900;font-weight:bold;">80</span></div>
        <div>Backend: <span id="backend" style="color:#76b900;font-weight:bold;">CPU</span></div>
        <div>CPU: <span id="cpuUsage" style="color:#76b900;font-weight:bold;">-</span></div>
        <div>Temp: <span id="temperature" style="color:#76b900;font-weight:bold;">-</span></div>
        <div>Fan: <span id="fanSpeed" style="color:#76b900;font-weight:bold;">-</span></div>
        <div>Power: <span id="powerMode" style="color:#76b900;font-weight:bold;">-</span></div>
        <div>Uptime: <span id="uptime" style="color:#76b900;font-weight:bold;">-</span></div>
      </div>
    </div>
  </div>
  <div style="max-width:800px;margin:10px auto;padding:10px;background:#222;border-radius:6px;">
    <label style="display:flex;align-items:center;gap:10px;">
      <span style="min-width:120px;">Set Quality:</span>
      <input type="range" id="qualitySlider" min="50" max="100" value="80" step="5" 
             style="flex:1;height:6px;background:#444;border-radius:3px;outline:none;">
      <span id="sliderValue" style="min-width:35px;text-align:center;color:#76b900;font-weight:bold;">80</span>
      <button id="applyQuality" style="padding:6px 16px;background:#76b900;color:#000;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Apply</button>
    </label>
  </div>
  <div style="max-width:800px;margin:10px auto;padding:10px;background:#222;border-radius:6px;">
    <label style="display:flex;align-items:center;gap:10px;">
      <span style="min-width:120px;">Face Detection:</span>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="faceDetectionToggle" style="width:20px;height:20px;cursor:pointer;">
        <span id="faceDetectionStatus" style="color:#888;">Disabled</span>
      </label>
    </label>
  </div>
  <canvas id="videoCanvas" width="640" height="480" style="width:100%;display:block;"></canvas>
  <script>
    // Stats collapse/expand toggle
    function toggleStats() {
      const content = document.getElementById('statsContent');
      const toggle = document.getElementById('statsToggle');
      content.classList.toggle('collapsed');
      toggle.classList.toggle('collapsed');
    }
    
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    let ws;
    let loading = false;
    function connect(){
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/ws/video`);
      ws.binaryType = 'arraybuffer';
      ws.onopen = ()=>{statusDiv.textContent='Connected';statusDiv.className='status connected';};
      ws.onmessage = (evt)=>{
        if (loading) return;
        const data = evt.data;
        if (data instanceof ArrayBuffer) {
          loading = true;
          const blob = new Blob([data], { type: 'image/jpeg' });
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = ()=>{
            const w = img.naturalWidth;
            const h = img.naturalHeight;
            if (canvas.width !== w || canvas.height !== h) {
              canvas.width = w;
              canvas.height = h;
              canvas.style.aspectRatio = `${w} / ${h}`;
            }
            ctx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);
            loading = false;
          };
          img.src = url;
        } else {
          // Fallback for JSON base64 frames
          try {
            const json = JSON.parse(data);
            const img = new Image();
            img.onload = ()=>{
              const w = img.naturalWidth;
              const h = img.naturalHeight;
              if (canvas.width !== w || canvas.height !== h) {
                canvas.width = w;
                canvas.height = h;
                canvas.style.aspectRatio = `${w} / ${h}`;
              }
              ctx.drawImage(img, 0, 0);
            };
            img.src = 'data:image/jpeg;base64,' + json.frame;
          } catch (e) {
            console.warn('Unknown message format');
          }
        }
      };
      ws.onclose = ()=>{statusDiv.textContent='Disconnected';statusDiv.className='status disconnected';setTimeout(connect,2000)};
      ws.onerror = (e)=>console.error('WebSocket error', e);
    }
    connect();
    
    // Quality control
    const qualitySlider = document.getElementById('qualitySlider');
    const sliderValue = document.getElementById('sliderValue');
    const currentQuality = document.getElementById('currentQuality');
    const applyQuality = document.getElementById('applyQuality');
    
    // Update slider display as user moves it (doesn't affect backend)
    qualitySlider.addEventListener('input', (e) => {
      sliderValue.textContent = e.target.value;
    });
    
    applyQuality.addEventListener('click', async () => {
      const quality = parseInt(qualitySlider.value);
      try {
        const res = await fetch('/api/quality', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({quality})
        });
        const data = await res.json();
        if (data.status === 'ok') {
          applyQuality.textContent = '✓ Applied';
          currentQuality.textContent = data.quality;
          setTimeout(() => applyQuality.textContent = 'Apply', 2000);
        }
      } catch (e) {
        console.error('Failed to set quality', e);
        applyQuality.textContent = '✗ Error';
        setTimeout(() => applyQuality.textContent = 'Apply', 2000);
      }
    });
    
    // Face detection control
    const faceDetectionToggle = document.getElementById('faceDetectionToggle');
    const faceDetectionStatus = document.getElementById('faceDetectionStatus');
    
    faceDetectionToggle.addEventListener('change', async (e) => {
      const enabled = e.target.checked;
      try {
        const res = await fetch('/api/face-detection', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({enabled})
        });
        const data = await res.json();
        if (data.status === 'ok') {
          faceDetectionStatus.textContent = data.enabled ? 'Enabled' : 'Disabled';
          faceDetectionStatus.style.color = data.enabled ? '#76b900' : '#888';
        }
      } catch (e) {
        console.error('Failed to toggle face detection', e);
      }
    });
    
    // Initialize face detection state
    (async () => {
      try {
        const res = await fetch('/api/face-detection');
        const data = await res.json();
        faceDetectionToggle.checked = data.enabled;
        faceDetectionStatus.textContent = data.enabled ? 'Enabled' : 'Disabled';
        faceDetectionStatus.style.color = data.enabled ? '#76b900' : '#888';
      } catch (e) {
        console.debug('Failed to get face detection status', e);
      }
    })();
    
    // Poll stats every second
    setInterval(async () => {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        document.getElementById('fps').textContent = data.actual_fps || 0;
        document.getElementById('memory').textContent = `${data.memory_mb || 0} MB (${data.memory_percent || 0}%)`;
        document.getElementById('backend').textContent = data.face_detection_backend || 'CPU';
        document.getElementById('currentQuality').textContent = data.jpeg_quality || 80;
        
        // System stats
        document.getElementById('cpuUsage').textContent = data.cpu_usage !== null ? `${data.cpu_usage}%` : '-';
        document.getElementById('uptime').textContent = data.uptime || '-';
        document.getElementById('powerMode').textContent = data.power_mode || '-';
        
        // Temperature
        if (data.temperature && Object.keys(data.temperature).length > 0) {
          const temps = Object.entries(data.temperature)
            .map(([k, v]) => `${k.toUpperCase()}: ${v}°C`)
            .join(', ');
          document.getElementById('temperature').textContent = temps;
        } else {
          document.getElementById('temperature').textContent = '-';
        }
        
        // Fan speed
        if (data.fan_speed !== null) {
          const fanPercent = Math.round((data.fan_speed / 255) * 100);
          document.getElementById('fanSpeed').textContent = `${fanPercent}%`;
        } else {
          document.getElementById('fanSpeed').textContent = '-';
        }
        // Update current quality display only (don't move the slider)
        currentQuality.textContent = data.jpeg_quality || 80;
      } catch (e) {
        console.debug('Stats fetch error', e);
      }
    }, 1000);
  </script>
</body>
</html>
